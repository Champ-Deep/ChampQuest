<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Champ Quest | Multi-Team Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Silkscreen&family=Poppins:wght@400;600;700&family=Rajdhani:wght@400;600;700&family=Space+Grotesk:wght@400;500;700&family=Orbitron:wght@400;500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <style>
    :root {
      --neon-primary: #ef4444;
      --neon-secondary: #3b82f6;
      --neon-accent: #f59e0b;
      --bg-dark: #0a0a0c;
      --bg-card: #151518;
      --bg-nav: #1c1c21;
      --border-dim: #2d2d35;
      --text-bright: #ffffff;
      --text-muted: #94a3b8;
      --text-dim: #64748b;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-bright);
      font-family: 'Inter', sans-serif;
      overflow: hidden;
    }

    .pixel-font {
      font-family: var(--font-heading, 'Silkscreen', cursive);
      text-transform: uppercase;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      height: 100vh;
    }

    .left-panel {
      background: var(--bg-nav);
      border-right: 1px solid var(--border-dim);
      overflow-y: auto;
    }

    .center-panel {
      background: var(--bg-dark);
      overflow-y: auto;
      position: relative;
    }

    .right-panel {
      background: var(--bg-nav);
      border-left: 1px solid var(--border-dim);
      overflow-y: auto;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-dim);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-dim);
    }

    .glass-card {
      background: rgba(30, 30, 35, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-dim);
      border-radius: 12px;
    }

    .glass-btn {
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.05);
    }

    .glass-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-5px);
      }
    }

    .animate-float {
      animation: float 3s ease-in-out infinite;
    }

    .task-card {
      background: var(--bg-card);
      border-left: 4px solid var(--neon-accent);
      transition: all 0.2s;
      border-radius: 8px;
    }

    .task-card:hover {
      border-left-width: 8px;
      transform: translateX(2px);
    }

    .task-card.priority-p0 {
      border-color: #ef4444;
    }

    .task-card.priority-p1 {
      border-color: #f59e0b;
    }

    .task-card.priority-p2 {
      border-color: #3b82f6;
    }

    .task-card.priority-p3 {
      border-color: #10b981;
    }

    .task-card.completed {
      opacity: 0.6;
      filter: grayscale(1);
      border-color: #475569;
    }

    .xp-bar-bg {
      background: rgba(255, 255, 255, 0.1);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .xp-bar-fill {
      height: 100%;
      background: var(--neon-accent);
      transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .stat-box {
      background: var(--bg-card);
      border: 1px solid var(--border-dim);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .mission-scanner {
      background: rgba(239, 68, 68, 0.05);
      border: 1px dashed var(--neon-primary);
      border-radius: 12px;
      padding: 16px;
    }

    .modal-backdrop {
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pokemon-sprite {
      image-rendering: pixelated;
      width: 48px;
      height: 48px;
    }

    .evolution-stage {
      font-size: 10px;
      color: var(--text-dim);
    }

    .pulse {
      animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
      0% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    .auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .team-selector-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: radial-gradient(ellipse at top, rgba(239, 68, 68, 0.1) 0%, transparent 50%);
    }

    .companion-emoji {
      line-height: 1;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .kudos-emoji-btn {
      padding: 2px 6px;
      border-radius: 6px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.15s, transform 0.15s;
    }
    .kudos-emoji-btn:hover { opacity: 0.8; transform: scale(1.1); }
    .kudos-emoji-btn.selected { opacity: 1; background: rgba(236, 72, 153, 0.2); }

    /* Theme-specific glass-card glow */
    [data-theme="pokemon"] .glass-card { border-color: rgba(239, 68, 68, 0.15); }
    [data-theme="bollywood"] .glass-card { border-color: rgba(251, 191, 36, 0.15); }
    [data-theme="cricket"] .glass-card { border-color: rgba(22, 163, 74, 0.15); }
    [data-theme="startup"] .glass-card { border-color: rgba(139, 92, 246, 0.15); }
    [data-theme="space"] .glass-card { border-color: rgba(99, 102, 241, 0.15); }

    /* Theme-specific mission scanner */
    [data-theme="pokemon"] .mission-scanner { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
    [data-theme="bollywood"] .mission-scanner { border-color: #b91c1c; background: rgba(185, 28, 28, 0.05); }
    [data-theme="cricket"] .mission-scanner { border-color: #1e40af; background: rgba(22, 163, 74, 0.05); }
    [data-theme="startup"] .mission-scanner { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.05); }
    [data-theme="space"] .mission-scanner { border-color: #6366f1; background: rgba(56, 189, 248, 0.05); }

    /* Theme-specific XP bar gradients */
    [data-theme="pokemon"] .xp-bar-fill { background: linear-gradient(90deg, #ef4444, #f59e0b); }
    [data-theme="bollywood"] .xp-bar-fill { background: linear-gradient(90deg, #b91c1c, #fbbf24); }
    [data-theme="cricket"] .xp-bar-fill { background: linear-gradient(90deg, #1e40af, #16a34a); }
    [data-theme="startup"] .xp-bar-fill { background: linear-gradient(90deg, #8b5cf6, #06b6d4); }
    [data-theme="space"] .xp-bar-fill { background: linear-gradient(90deg, #6366f1, #38bdf8); }
  </style>
</head>

<body>

  <!-- ==================== AUTH SCREENS ==================== -->
  <div id="authScreen" class="auth-screen">
    <div class="glass-card p-8 w-full max-w-md animate__animated animate__zoomIn">
      <div class="text-center mb-8">
        <h1 class="pixel-font text-2xl text-red-500 mb-2">‚öîÔ∏è CHAMP QUEST ‚öîÔ∏è</h1>
        <p class="text-sm text-slate-400">Multi-Team Quest Platform</p>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="space-y-4">
        <div>
          <label class="pixel-font text-[10px] text-slate-500 mb-1 block">Email</label>
          <input type="email" id="loginEmail" placeholder="your@email.com"
            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
        <div>
          <label class="pixel-font text-[10px] text-slate-500 mb-1 block">Password</label>
          <input type="password" id="loginPassword" placeholder="Enter password"
            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
        <button onclick="login()"
          class="w-full bg-red-600 hover:bg-red-700 text-white pixel-font py-4 rounded-lg transition-all transform hover:scale-[1.02]">LOGIN</button>
        <div id="loginError" class="text-red-500 text-xs text-center hidden"></div>
        <div class="text-center space-x-3">
          <button onclick="showRegister()" class="text-xs text-slate-400 hover:text-white">No account?</button>
          <button onclick="showForgotPassword()" class="text-xs text-slate-400 hover:text-white">Forgot
            password?</button>
        </div>
      </div>

      <!-- Register Form -->
      <div id="registerForm" class="space-y-4 hidden">
        <div>
          <label class="pixel-font text-[10px] text-slate-500 mb-1 block">Display Name</label>
          <input type="text" id="registerName" placeholder="Your name"
            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
        <div>
          <label class="pixel-font text-[10px] text-slate-500 mb-1 block">Email</label>
          <input type="email" id="registerEmail" placeholder="your@email.com"
            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
        <div>
          <label class="pixel-font text-[10px] text-slate-500 mb-1 block">Password</label>
          <input type="password" id="registerPassword" placeholder="Create password"
            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
        <button onclick="register()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white pixel-font py-4 rounded-lg transition-all transform hover:scale-[1.02]">REGISTER</button>
        <div id="registerError" class="text-red-500 text-xs text-center hidden"></div>
        <button onclick="showLogin()" class="w-full text-xs text-slate-400 hover:text-white">Already have an
          account?</button>
      </div>

      <!-- Forgot Password Form -->
      <div id="forgotPasswordForm" class="space-y-4 hidden">
        <div class="text-center mb-4">
          <p class="text-sm text-slate-400">Enter your email and we'll send you a reset link.</p>
        </div>
        <div>
          <label class="pixel-font text-[10px] text-slate-500 mb-1 block">Email</label>
          <input type="email" id="forgotEmail" placeholder="your@email.com"
            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-red-500 transition-colors">
        </div>
        <button onclick="forgotPassword()"
          class="w-full bg-amber-600 hover:bg-amber-700 text-white pixel-font py-4 rounded-lg transition-all">SEND RESET
          LINK</button>
        <div id="forgotError" class="text-red-500 text-xs text-center hidden"></div>
        <div id="forgotSuccess" class="text-emerald-500 text-xs text-center hidden"></div>
        <button onclick="showLogin()" class="w-full text-xs text-slate-400 hover:text-white">Back to login</button>
      </div>
    </div>
  </div>

  <!-- ==================== TEAM SELECTOR SCREEN ==================== -->
  <div id="teamSelectorScreen" class="team-selector-screen hidden">
    <div class="glass-card p-8 w-full max-w-2xl animate__animated animate__zoomIn">
      <div class="text-center mb-8">
        <h1 class="pixel-font text-2xl text-red-500 mb-2">üéÆ SELECT TEAM üéÆ</h1>
        <p class="text-sm text-slate-400">Choose a team to continue your quest</p>
      </div>

      <!-- User Info -->
      <div class="flex items-center justify-center gap-4 mb-8 p-4 bg-slate-900/50 rounded-lg">
        <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center">
          <i data-lucide="user" class="w-6 h-6 text-slate-400"></i>
        </div>
        <div class="text-left">
          <div id="selectorUserName" class="font-bold text-white">Loading...</div>
          <div id="selectorUserEmail" class="text-xs text-slate-500">Loading...</div>
        </div>
        <button onclick="logout()" class="ml-4 text-xs text-slate-500 hover:text-red-500 flex items-center gap-1">
          <i data-lucide="log-out" class="w-3 h-3"></i> Logout
        </button>
      </div>

      <!-- My Teams -->
      <div class="mb-6">
        <h3 class="pixel-font text-[10px] text-slate-500 mb-3">YOUR TEAMS</h3>
        <div id="userTeamsList" class="grid grid-cols-2 gap-4">
          <!-- Teams populated by JS -->
        </div>
      </div>

      <!-- Join/Create -->
      <div class="border-t border-slate-800 pt-6">
        <h3 class="pixel-font text-[10px] text-slate-500 mb-3">JOIN OR CREATE</h3>
        <div class="grid grid-cols-2 gap-4">
          <button onclick="showJoinTeamModal()" class="glass-card p-4 hover:bg-slate-800 transition-colors text-center">
            <i data-lucide="users" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i>
            <div class="text-sm font-bold text-white">Join Team</div>
            <div class="text-xs text-slate-500">Enter team code</div>
          </button>
          <button onclick="showCreateTeamModal()"
            class="glass-card p-4 hover:bg-slate-800 transition-colors text-center">
            <i data-lucide="plus-circle" class="w-8 h-8 text-emerald-500 mx-auto mb-2"></i>
            <div class="text-sm font-bold text-white">Create Team</div>
            <div class="text-xs text-slate-500">Start new adventure</div>
          </button>
        </div>
      </div>

      <!-- Admin Link -->
      <div id="superadminLink" class="mt-6 text-center hidden">
        <button onclick="showSuperadminPanel()"
          class="text-xs text-amber-500 hover:text-amber-400 flex items-center justify-center gap-2">
          <i data-lucide="crown" class="w-4 h-4"></i> Superadmin Panel
        </button>
      </div>
    </div>
  </div>

  <!-- Join Team Modal -->
  <div id="joinTeamModal" class="modal-backdrop hidden">
    <div class="glass-card p-6 w-full max-w-md">
      <h2 class="pixel-font text-lg text-white mb-4">Join Team</h2>
      <input type="text" id="joinTeamCode" placeholder="Enter team code"
        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white mb-4">
      <div class="flex justify-end gap-3">
        <button onclick="hideJoinTeamModal()" class="px-4 py-2 text-slate-400">Cancel</button>
        <button onclick="joinTeamByCode()" class="bg-blue-600 px-6 py-2 rounded text-white">Join</button>
      </div>
      <div id="joinTeamError" class="text-red-500 text-xs mt-2 hidden"></div>
    </div>
  </div>

  <!-- Create Team Modal -->
  <div id="createTeamModal" class="modal-backdrop hidden">
    <div class="glass-card p-6 w-full max-w-md">
      <h2 class="pixel-font text-lg text-white mb-4">Create Team</h2>
      <div class="mb-4">
        <label class="text-xs text-slate-500 mb-1 block">Team Name</label>
        <input type="text" id="createTeamName" placeholder="Enter team name"
          class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-emerald-500">
      </div>
      <div class="flex justify-end gap-3">
        <button onclick="hideCreateTeamModal()" class="px-4 py-2 text-slate-400">Cancel</button>
        <button onclick="createTeam()" class="bg-emerald-600 px-6 py-2 rounded text-white pixel-font">Create</button>
      </div>
      <div id="createTeamError" class="text-red-500 text-xs mt-2 hidden"></div>
      <div id="createTeamSuccess" class="text-emerald-500 text-xs mt-2 hidden"></div>
    </div>
  </div>

  <!-- Superadmin Panel -->
  <div id="superadminPanel" class="hidden" style="min-height:100vh; background: var(--bg-dark); overflow-y: auto;">
    <div class="max-w-6xl mx-auto p-6">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="pixel-font text-2xl text-amber-500">SUPERADMIN PANEL</h1>
          <p class="text-sm text-slate-500">Platform management dashboard</p>
        </div>
        <button onclick="closeSuperadminPanel()" class="glass-btn px-4 py-2 rounded text-slate-400 text-sm flex items-center gap-2">
          <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
        </button>
      </div>

      <!-- Stats Row -->
      <div class="grid grid-cols-4 gap-4 mb-8" id="adminStatsRow">
        <div class="stat-box"><div class="text-amber-500 text-2xl mb-1" id="adminStatTeams">-</div><div class="text-[9px] pixel-font text-slate-500">TEAMS</div></div>
        <div class="stat-box"><div class="text-blue-500 text-2xl mb-1" id="adminStatUsers">-</div><div class="text-[9px] pixel-font text-slate-500">USERS</div></div>
        <div class="stat-box"><div class="text-red-500 text-2xl mb-1" id="adminStatTasks">-</div><div class="text-[9px] pixel-font text-slate-500">TASKS</div></div>
        <div class="stat-box"><div class="text-emerald-500 text-2xl mb-1" id="adminStatCompleted">-</div><div class="text-[9px] pixel-font text-slate-500">COMPLETED</div></div>
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 mb-6">
        <button onclick="showAdminTab('teams')" id="adminTabTeams" class="pixel-font text-xs px-4 py-2 rounded bg-amber-600 text-white">TEAMS</button>
        <button onclick="showAdminTab('users')" id="adminTabUsers" class="pixel-font text-xs px-4 py-2 rounded bg-slate-800 text-slate-400">USERS</button>
      </div>

      <!-- Teams Tab -->
      <div id="adminTeamsContent">
        <div class="flex items-center justify-between mb-4">
          <h3 class="pixel-font text-xs text-slate-500">ALL TEAMS</h3>
          <button onclick="adminCreateTeam()" class="bg-emerald-600/20 text-emerald-500 border border-emerald-500/30 px-4 py-2 rounded text-xs pixel-font">+ NEW TEAM</button>
        </div>
        <div id="adminTeamsList" class="space-y-3"></div>
      </div>

      <!-- Users Tab -->
      <div id="adminUsersContent" class="hidden">
        <h3 class="pixel-font text-xs text-slate-500 mb-4">ALL USERS</h3>
        <div id="adminUsersList" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div id="editTaskModal" class="modal-backdrop hidden">
    <div class="glass-card p-6 w-full max-w-lg">
      <h2 class="pixel-font text-lg text-white mb-6">EDIT MISSION</h2>
      <input type="hidden" id="editTaskId">
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="col-span-2">
          <label class="text-xs text-slate-500 mb-1 block">Title</label>
          <input type="text" id="editTaskTitle" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Priority</label>
          <select id="editTaskPriority" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
            <option value="P0">P0 (FIRE)</option>
            <option value="P1">P1 (ELECTRIC)</option>
            <option value="P2">P2 (WATER)</option>
            <option value="P3">P3 (GRASS)</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Assign To</label>
          <select id="editTaskAssign" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white"></select>
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Category</label>
          <input type="text" id="editTaskCategory" placeholder="e.g. Design, Backend" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Due Date</label>
          <input type="date" id="editTaskDueDate" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Time Estimate</label>
          <input type="text" id="editTaskTimeEstimate" placeholder="e.g. 2h, 30m" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
        </div>
        <div class="col-span-2">
          <label class="text-xs text-slate-500 mb-1 block">Notes</label>
          <textarea id="editTaskNotes" rows="2" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white"></textarea>
        </div>
      </div>
      <div class="flex justify-end gap-3">
        <button onclick="hideEditTaskModal()" class="px-4 py-2 text-slate-400">Cancel</button>
        <button onclick="saveEditTask()" class="bg-blue-600 px-6 py-2 rounded pixel-font text-white">SAVE CHANGES</button>
      </div>
    </div>
  </div>

  <!-- Main App Layout -->
  <div id="mainApp" class="dashboard-grid hidden">
    <aside class="left-panel p-5 flex flex-col">
      <div class="mb-8 overflow-hidden">
        <div class="flex items-center gap-3 mb-4">
          <div
            class="w-12 h-12 rounded-full overflow-hidden bg-slate-800 border-2 border-red-500 flex items-center justify-center">
            <img id="sidebarSprite" src="" class="pokemon-sprite animate-float" alt="Trainer"
              onerror="if(this.dataset.fallback){this.src=this.dataset.fallback;this.dataset.fallback=''}else{this.style.display='none'}">
            <span id="sidebarEmoji" class="companion-emoji text-2xl hidden"></span>
          </div>
          <div>
            <h2 id="sidebarUserName" class="font-bold text-white truncate w-32">Loading...</h2>
            <div class="flex items-center gap-1">
              <span id="sidebarLevelTag" class="text-[10px] bg-red-600 text-white px-1.5 rounded pixel-font">LV.
                1</span>
              <span id="sidebarRank" class="text-[10px] text-slate-400 truncate">Rookie Trainer</span>
            </div>
          </div>
        </div>
        <div class="xp-bar-bg mb-1">
          <div id="sidebarXPBar" class="xp-bar-fill" style="width: 45%;"></div>
        </div>
        <div class="flex justify-between text-[10px] pixel-font text-slate-500">
          <span><span id="sidebarXP">0</span> XP</span>
          <span><span id="sidebarNextXP">100</span> XP</span>
        </div>
      </div>

      <nav class="space-y-1 flex-1">
        <div class="pixel-font text-[10px] text-slate-600 mb-2 mt-4">NAVIGATE</div>
        <button onclick="setTaskFilter('all')" id="filterAll"
          class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors hover:bg-slate-800 text-white bg-slate-800 group">
          <i data-lucide="layout-grid" class="w-4 h-4 group-hover:text-red-500"></i>
          <span data-term="missions">Team Board</span>
        </button>
        <button onclick="setTaskFilter('mine')" id="filterMine"
          class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors hover:bg-slate-800 text-slate-400 group">
          <i data-lucide="user" class="w-4 h-4 group-hover:text-red-500"></i>
          <span>My Assignments</span>
        </button>

        <div class="pixel-font text-[10px] text-slate-600 mb-2 mt-6">LEADERBOARD TOP 5</div>
        <div id="leaderboard" class="space-y-3 mt-2"></div>

        <div class="pixel-font text-[10px] text-slate-600 mb-2 mt-6">RECENT ACTIVITY</div>
        <div id="sidebarActivity" class="space-y-1.5 mt-2"></div>
      </nav>

      <div class="mt-auto space-y-2 border-t border-slate-800 pt-4">
        <select id="themeSelector" onchange="changeUserTheme(this.value)"
          class="w-full bg-slate-900 border border-slate-800 text-xs rounded p-2 text-slate-300">
          <option value="pokemon">üêâ Pok√©mon (Default)</option>
          <option value="bollywood">üé¨ Bollywood</option>
          <option value="cricket">üèè Cricket IPL</option>
          <option value="startup">üöÄ Startup Unicorn</option>
          <option value="space">üåå Space Explorer</option>
        </select>
        <div class="flex gap-2">
          <button onclick="showSettingsModal()" id="settingsBtn"
            class="flex-1 glass-btn py-2 rounded text-xs text-slate-400 flex items-center justify-center gap-2 hidden">
            <i data-lucide="settings" class="w-3 h-3"></i> Settings
          </button>
          <button onclick="showTeamAdminModal()" id="teamAdminBtn"
            class="flex-1 glass-btn py-2 rounded text-xs text-slate-400 flex items-center justify-center gap-2 hidden">
            <i data-lucide="shield-check" class="w-3 h-3"></i> Admin
          </button>
          <button onclick="backToTeamSelector()"
            class="flex-1 glass-btn py-2 rounded text-xs text-slate-400 flex items-center justify-center gap-2">
            <i data-lucide="grid" class="w-3 h-3"></i> Teams
          </button>
        </div>
      </div>
    </aside>

    <main class="center-panel">
      <header class="p-6 flex justify-between items-center bg-slate-900/50 border-b border-slate-800">
        <div>
          <h1 id="headerTeamName" class="pixel-font text-lg text-red-500">TEAM NAME</h1>
          <p class="text-xs text-slate-500">Mission Command Center</p>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <div id="currentDate" class="text-xs font-medium text-white">Loading...</div>
            <div class="text-[10px] text-slate-500 pixel-font">MISSION DAY</div>
          </div>
          <button onclick="loadData()" class="p-2 glass-btn rounded-full"><i data-lucide="refresh-cw"
              class="w-4 h-4"></i></button>
        </div>
      </header>

      <div class="p-6 space-y-8">
        <div class="grid grid-cols-4 gap-4">
          <div class="stat-box">
            <div class="text-red-500 text-lg mb-1" id="statActive">0</div>
            <div class="text-[9px] pixel-font text-slate-500">ACTIVE</div>
          </div>
          <div class="stat-box">
            <div class="text-emerald-500 text-lg mb-1" id="statToday">0</div>
            <div class="text-[9px] pixel-font text-slate-500">COMPLETED</div>
          </div>
          <div class="stat-box">
            <div class="text-amber-500 text-lg mb-1" id="statStreak">0</div>
            <div class="text-[9px] pixel-font text-slate-500">STREAK</div>
          </div>
          <div class="stat-box">
            <div class="text-blue-500 text-lg mb-1" id="statMVP">-</div>
            <div class="text-[9px] pixel-font text-slate-500">MVP</div>
          </div>
        </div>

        <section class="mission-scanner animate__animated animate__fadeIn">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <span class="text-lg">üì±</span>
              <h3 class="pixel-font text-xs text-red-500" data-term="scanner">MISSION SCANNER AI</h3>
            </div>
            <span class="text-[10px] text-slate-500" data-term="scannerHint">Dump notes, I'll extract tasks!</span>
          </div>
          <textarea id="quickCaptureInput" rows="2"
            placeholder="e.g., Fix the login bug P0 assign to Sreedeep. Also plan the offsite for next Friday."
            class="w-full bg-slate-950/50 border border-slate-800 rounded-lg p-3 text-sm focus:outline-none focus:border-red-500 transition-all"></textarea>
          <div class="flex justify-end gap-3 mt-3">
            <button onclick="clearCapture()" class="text-xs text-slate-500 hover:text-white px-3">Clear</button>
            <button onclick="parseNotes()"
              class="bg-red-600/20 text-red-500 border border-red-500/30 px-4 py-2 rounded text-xs pixel-font hover:bg-red-600/30 transition-all">‚ú®
              SCAN WITH AI</button>
            <button onclick="showTaskForm()"
              class="bg-blue-600/20 text-blue-500 border border-blue-500/30 px-4 py-2 rounded text-xs pixel-font hover:bg-blue-600/30 transition-all">+
              MANUAL ADD</button>
          </div>
          <div id="parsedTasksPreview" class="mt-4 border-t border-slate-800 pt-4 hidden">
            <div id="parsedTasksList" class="space-y-2 mb-4"></div>
            <div class="flex justify-end gap-2">
              <button onclick="cancelParsedTasks()" class="px-3 py-1 text-xs text-slate-500">Discard</button>
              <button onclick="confirmParsedTasks()"
                class="px-4 py-1 text-xs pixel-font bg-emerald-600 text-white rounded">CONFIRM & ADD ALL</button>
            </div>
          </div>
        </section>

        <section>
          <div class="flex items-center justify-between mb-4">
            <h3 class="pixel-font text-xs text-slate-500" data-term="missions">ACTIVE MISSIONS</h3>
            <div class="flex items-center gap-2">
              <input type="text" id="taskSearch" placeholder="Search..." 
                class="bg-slate-900 border border-slate-700 rounded px-3 py-1 text-xs text-white focus:outline-none focus:border-red-500"
                oninput="filterTasks()">
              <button onclick="setPriorityFilter(null)" id="filterPriorityAll" class="bg-slate-800 text-[10px] pixel-font px-2 py-1 rounded text-white">ALL</button>
              <button onclick="setPriorityFilter('P0')" id="filterPriorityP0" class="bg-slate-800 text-[10px] pixel-font px-2 py-1 rounded text-red-500">P0</button>
              <button onclick="setPriorityFilter('P1')" id="filterPriorityP1" class="bg-slate-800 text-[10px] pixel-font px-2 py-1 rounded text-amber-500">P1</button>
              <button onclick="setPriorityFilter('P2')" id="filterPriorityP2" class="bg-slate-800 text-[10px] pixel-font px-2 py-1 rounded text-blue-500">P2</button>
              <button onclick="setPriorityFilter('P3')" id="filterPriorityP3" class="bg-slate-800 text-[10px] pixel-font px-2 py-1 rounded text-emerald-500">P3</button>
            </div>
          </div>
          <div id="taskList" class="space-y-3">
            <div id="emptyState" class="text-center py-20 hidden">
              <i data-lucide="clipboard-check" class="w-12 h-12 text-slate-700 mx-auto mb-4"></i>
              <p class="text-slate-500 text-sm">All missions cleared. Rest up, Champ!</p>
            </div>
          </div>
        </section>
      </div>
    </main>

    <aside class="right-panel p-5 space-y-6">
      <section class="glass-card p-4">
        <div class="flex items-center gap-2 mb-4">
          <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i>
          <h3 class="pixel-font text-[10px] text-amber-500" data-term="companion">COMPANION STATUS</h3>
        </div>
        <div class="flex items-center gap-4 mb-4">
          <div
            class="w-20 h-20 bg-slate-900 rounded-lg flex items-center justify-center border border-slate-800 relative group overflow-hidden">
            <img id="companionSprite" src="" class="pokemon-sprite relative z-10 animate-float"
              style="width: 68px; height: 68px;" onerror="if(this.dataset.fallback){this.src=this.dataset.fallback;this.dataset.fallback=''}else{this.style.display='none'}">
            <span id="companionEmoji" class="companion-emoji text-5xl hidden"></span>
          </div>
          <div>
            <div id="companionName" class="font-bold text-white text-lg">Bulbasaur</div>
            <div id="companionEvolution" class="evolution-stage pixel-font">STG 1 Evolution</div>
          </div>
        </div>
        <div class="space-y-1">
          <div class="flex justify-between text-[9px] pixel-font text-slate-500">
            <span>EVOLUTION PROGRESS</span>
            <span id="evolutionProgressText">45%</span>
          </div>
          <div class="xp-bar-bg h-2">
            <div id="evolutionProgressBar" class="xp-bar-fill shadow-[0_0_10px_rgba(245,158,11,0.5)]"
              style="width: 45%;"></div>
          </div>
          <p class="text-[10px] text-slate-500 mt-2 italic" id="companionNote">"Looking strong today, Champ!"</p>
        </div>
      </section>

      <section class="glass-card p-4">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <i data-lucide="target" class="w-4 h-4 text-red-500"></i>
            <h3 class="pixel-font text-[10px] text-red-500" data-term="challenges">DAILY CHALLENGES</h3>
          </div>
        </div>
        <div id="dailyChallenges" class="space-y-4"></div>
      </section>

      <section class="glass-card p-4 flex-1 flex flex-col min-h-0">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <i data-lucide="heart" class="w-4 h-4 text-pink-500"></i>
            <h3 class="pixel-font text-[10px] text-pink-500">TEAM KUDOS</h3>
          </div>
          <button onclick="toggleKudosForm()" class="text-[9px] px-2 py-1 rounded bg-pink-500/20 text-pink-400 hover:bg-pink-500/30 pixel-font">+ GIVE</button>
        </div>
        <div id="kudosForm" class="hidden mb-4 space-y-2">
          <select id="kudosRecipient" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white"></select>
          <input id="kudosMessage" type="text" maxlength="280" placeholder="Write something nice..."
            class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white">
          <div class="flex items-center gap-2">
            <div id="kudosEmojiPicker" class="flex gap-1">
              <button onclick="selectKudosEmoji(this, '\u{1F389}')" class="text-lg kudos-emoji-btn selected">\u{1F389}</button>
              <button onclick="selectKudosEmoji(this, '\u{1F31F}')" class="text-lg kudos-emoji-btn">\u{1F31F}</button>
              <button onclick="selectKudosEmoji(this, '\u{1F525}')" class="text-lg kudos-emoji-btn">\u{1F525}</button>
              <button onclick="selectKudosEmoji(this, '\u{1F4AA}')" class="text-lg kudos-emoji-btn">\u{1F4AA}</button>
              <button onclick="selectKudosEmoji(this, '\u{1F64F}')" class="text-lg kudos-emoji-btn">\u{1F64F}</button>
            </div>
            <button onclick="sendKudos()" class="ml-auto text-[10px] px-3 py-1 rounded bg-pink-600 text-white pixel-font">SEND</button>
          </div>
          <div id="kudosError" class="text-red-500 text-[10px] hidden"></div>
        </div>
        <div id="kudosFeed" class="space-y-3 overflow-y-auto max-h-[300px] pr-2">
          <div class="text-center text-slate-600 text-xs py-4">No kudos yet. Be the first!</div>
        </div>
      </section>

      <div id="activityFeed" class="hidden"></div>
    </aside>
  </div>

  <!-- Task Modal -->
  <div id="taskModal" class="modal-backdrop hidden">
    <div class="glass-card p-6 w-full max-w-lg">
      <h2 class="pixel-font text-lg text-white mb-6">NEW MISSION</h2>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="col-span-2">
          <label class="text-xs text-slate-500 mb-1 block">Title</label>
          <input type="text" id="newTaskInput"
            class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Priority</label>
          <select id="newTaskPriority" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
            <option value="P0">P0 (FIRE)</option>
            <option value="P1">P1 (ELECTRIC)</option>
            <option value="P2" selected>P2 (WATER)</option>
            <option value="P3">P3 (GRASS)</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Assign To</label>
          <select id="newTaskAssign"
            class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white"></select>
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Category</label>
          <input type="text" id="newTaskCategory" placeholder="e.g. Design, Backend"
            class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Due Date</label>
          <input type="date" id="newTaskDueDate"
            class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
        </div>
        <div>
          <label class="text-xs text-slate-500 mb-1 block">Time Estimate</label>
          <input type="text" id="newTaskTimeEstimate" placeholder="e.g. 2h, 30m"
            class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
        </div>
        <div class="col-span-2">
          <label class="text-xs text-slate-500 mb-1 block">Notes</label>
          <textarea id="newTaskNotes" rows="2" placeholder="Additional details..."
            class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white"></textarea>
        </div>
      </div>
      <div class="flex justify-end gap-3">
        <button onclick="hideTaskForm()" class="px-4 py-2 text-slate-400">Cancel</button>
        <button onclick="addTask()" class="bg-red-600 px-6 py-2 rounded pixel-font text-white">CREATE QUEST</button>
      </div>
    </div>
  </div>

  <!-- Team Admin Modal -->
  <div id="teamAdminModal" class="modal-backdrop hidden">
    <div class="glass-card p-6 w-full max-w-2xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="pixel-font text-lg text-white">üëë TEAM ADMINISTRATION</h2>
        <button onclick="hideTeamAdminModal()" class="text-slate-500">‚úï</button>
      </div>
      <div id="teamMemberList" class="space-y-3 max-h-[500px] overflow-y-auto"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-backdrop hidden">
    <div class="glass-card p-6 w-full max-w-lg">
      <div class="flex justify-between items-center mb-6">
        <h2 class="pixel-font text-lg text-white">SETTINGS</h2>
        <button onclick="hideSettingsModal()" class="text-slate-500 text-lg">‚úï</button>
      </div>

      <div class="space-y-6">
        <!-- Profile Section -->
        <div>
          <h3 class="pixel-font text-[10px] text-slate-500 mb-3">PROFILE</h3>
          <div class="space-y-3">
            <div>
              <label class="text-xs text-slate-500 mb-1 block">Display Name</label>
              <div class="text-sm text-white" id="settingsDisplayName">-</div>
            </div>
            <div>
              <label class="text-xs text-slate-500 mb-1 block">Theme</label>
              <select id="settingsThemeSelect" onchange="changeUserTheme(this.value)"
                class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white">
                <option value="pokemon">üêâ Pokemon</option>
                <option value="bollywood">üé¨ Bollywood Blockbuster</option>
                <option value="cricket">üèè Cricket IPL</option>
                <option value="startup">üöÄ Startup Unicorn</option>
                <option value="space">üåå Space Explorer</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Webhook Section (Admin only) -->
        <div id="settingsWebhookSection" class="hidden">
          <h3 class="pixel-font text-[10px] text-slate-500 mb-3">WEBHOOKS (ADMIN)</h3>
          <div class="space-y-3">
            <div>
              <label class="text-xs text-slate-500 mb-1 block">Webhook URL (Slack/Discord)</label>
              <input type="url" id="settingsWebhookUrl" placeholder="https://hooks.slack.com/services/..."
                class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white">
            </div>
            <div class="flex items-center gap-3">
              <label class="text-xs text-slate-400">Enabled</label>
              <input type="checkbox" id="settingsWebhookEnabled" class="accent-pink-500">
            </div>
            <div>
              <label class="text-xs text-slate-500 mb-1 block">Events</label>
              <div class="space-y-1">
                <label class="flex items-center gap-2 text-xs text-slate-400"><input type="checkbox" class="webhook-event accent-pink-500" value="task_completed" checked> Task Completed</label>
                <label class="flex items-center gap-2 text-xs text-slate-400"><input type="checkbox" class="webhook-event accent-pink-500" value="level_up" checked> Level Up</label>
                <label class="flex items-center gap-2 text-xs text-slate-400"><input type="checkbox" class="webhook-event accent-pink-500" value="kudos_given"> Kudos Given</label>
                <label class="flex items-center gap-2 text-xs text-slate-400"><input type="checkbox" class="webhook-event accent-pink-500" value="task_created"> Task Created</label>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="saveWebhookSettings()" class="bg-blue-600 px-4 py-2 rounded text-xs pixel-font text-white">SAVE</button>
              <button onclick="testWebhook()" class="bg-slate-700 px-4 py-2 rounded text-xs pixel-font text-white">TEST WEBHOOK</button>
            </div>
            <div id="settingsWebhookStatus" class="text-[10px] hidden"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="api.js"></script>
  <script src="themes.js"></script>
  <script>
    // GSAP Animation Utilities
    const ChampAnimations = {
      _hasGsap() { return typeof gsap !== 'undefined'; },

      animateTasksIn() {
        if (!this._hasGsap()) return;
        const cards = document.querySelectorAll('.task-card');
        if (cards.length === 0) return;
        gsap.fromTo(cards, { opacity: 0, y: 20 }, { opacity: 1, y: 0, stagger: 0.04, duration: 0.35, ease: 'power2.out' });
      },

      animateXPBar(id, targetWidth) {
        if (!this._hasGsap()) return;
        const bar = document.getElementById(id);
        if (!bar) return;
        gsap.fromTo(bar, { width: '5%' }, { width: targetWidth, duration: 0.8, ease: 'elastic.out(1, 0.5)' });
      },

      animateCounter(id, targetValue) {
        if (!this._hasGsap()) return;
        const el = document.getElementById(id);
        if (!el) return;
        const num = parseInt(targetValue);
        if (isNaN(num) || num === 0) { el.textContent = targetValue; return; }
        const obj = { val: 0 };
        gsap.to(obj, { val: num, duration: 0.6, ease: 'power1.out', onUpdate: () => { el.textContent = Math.round(obj.val); } });
      },

      animateThemeTransition(callback) {
        if (!this._hasGsap()) { callback(); return; }
        const main = document.getElementById('mainApp');
        if (!main) { callback(); return; }
        gsap.to(main, { opacity: 0.3, duration: 0.15, ease: 'power1.in', onComplete: () => {
          callback();
          gsap.to(main, { opacity: 1, duration: 0.3, ease: 'power1.out' });
        }});
      },

      animateCompanionEntrance() {
        if (!this._hasGsap()) return;
        const companion = document.getElementById('companionSprite');
        const emoji = document.getElementById('companionEmoji');
        const target = (companion && companion.style.display !== 'none') ? companion : emoji;
        if (!target || target.classList.contains('hidden')) return;
        gsap.fromTo(target, { scale: 0, rotation: -15 }, { scale: 1, rotation: 0, duration: 0.5, ease: 'back.out(1.7)' });
      },

      levelUpCelebration() {
        if (!this._hasGsap()) return;
        const companion = document.getElementById('companionSprite');
        const emoji = document.getElementById('companionEmoji');
        const target = (companion && companion.style.display !== 'none') ? companion : emoji;
        if (!target || target.classList.contains('hidden')) return;
        gsap.timeline()
          .to(target, { scale: 1.3, duration: 0.2, ease: 'power2.out' })
          .to(target, { scale: 1, duration: 0.4, ease: 'elastic.out(1, 0.4)' })
          .to(target.closest('.glass-card') || target, { boxShadow: '0 0 30px rgba(245, 158, 11, 0.6)', duration: 0.3 }, 0)
          .to(target.closest('.glass-card') || target, { boxShadow: 'none', duration: 0.5 }, 0.5);
      },

      animateCardComplete(cardEl) {
        if (!this._hasGsap() || !cardEl) return;
        gsap.to(cardEl, { scale: 0.95, opacity: 0.6, duration: 0.3, ease: 'power2.in' });
      }
    };

    window.ChampAnimations = ChampAnimations;
  </script>
  <script>
    let currentUser = null, currentTeam = null, tasks = [], teamMembers = [], taskFilter = 'all', parsedTasks = [];
    let userTeams = [], refreshInterval = null;

    async function init() {
      lucide.createIcons();
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

      const session = API.init();
      if (session) {
        try {
          currentUser = await API.getMe();
          if (currentUser.themePreference) applyTheme(currentUser.themePreference);
          await showTeamSelector();
        } catch (e) {
          API.clearSession();
          showAuthScreen();
        }
      } else {
        showAuthScreen();
      }
    }

    function showAuthScreen() {
      document.getElementById('authScreen').classList.remove('hidden');
      document.getElementById('teamSelectorScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    function showLogin() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.add('hidden');
    }

    function showRegister() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('forgotPasswordForm').classList.add('hidden');
    }

    function showForgotPassword() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.remove('hidden');
    }

    async function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const err = document.getElementById('loginError');
      if (!email || !password) return;
      try {
        await API.login(email, password);
        currentUser = await API.getMe();
        if (currentUser.themePreference) applyTheme(currentUser.themePreference);
        await showTeamSelector();
      } catch (e) {
        err.textContent = e.message;
        err.classList.remove('hidden');
      }
    }

    async function register() {
      const name = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const err = document.getElementById('registerError');
      if (!name || !email || !password) return;
      try {
        await API.register(email, password, name);
        currentUser = await API.getMe();
        await showTeamSelector();
      } catch (e) {
        err.textContent = e.message;
        err.classList.remove('hidden');
      }
    }

    async function forgotPassword() {
      const email = document.getElementById('forgotEmail').value.trim();
      const err = document.getElementById('forgotError');
      const success = document.getElementById('forgotSuccess');
      if (!email) return;
      try {
        await API.forgotPassword(email);
        success.classList.remove('hidden');
        err.classList.add('hidden');
      } catch (e) {
        err.textContent = e.message;
        err.classList.remove('hidden');
        success.classList.add('hidden');
      }
    }

    async function showTeamSelector() {
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('teamSelectorScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');

      document.getElementById('selectorUserName').textContent = currentUser.displayName;
      document.getElementById('selectorUserEmail').textContent = currentUser.email;

      if (currentUser.globalRole === 'superadmin') {
        document.getElementById('superadminLink').classList.remove('hidden');
      } else {
        document.getElementById('superadminLink').classList.add('hidden');
      }

      await refreshTeamList();
      lucide.createIcons();
    }

    async function refreshTeamList() {
      try {
        userTeams = await API.getTeams();
        const container = document.getElementById('userTeamsList');
        if (userTeams.length === 0) {
          container.innerHTML = '<div class="col-span-2 text-center text-slate-500 py-8">No teams yet. Join or create one!</div>';
          return;
        }
        container.innerHTML = userTeams.map(t => `
          <div onclick="selectTeam(${t.id}, '${t.name.replace(/'/g, "\\'")}')" class="glass-card p-4 cursor-pointer hover:bg-slate-800 transition-colors border-2 ${currentTeam?.id === t.id ? 'border-red-500' : 'border-transparent'}">
            <div class="font-bold text-white mb-1">${t.name}</div>
            <div class="text-xs text-slate-500 mb-2">Code: ${t.code}</div>
            <div class="flex items-center gap-2 text-xs text-slate-400">
              <span>XP: ${t.xp || 0}</span>
              <span>‚Ä¢</span>
              <span class="capitalize">${t.memberRole}</span>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load teams:', e);
      }
    }

    function showJoinTeamModal() {
      document.getElementById('joinTeamModal').classList.remove('hidden');
      document.getElementById('joinTeamCode').value = '';
      document.getElementById('joinTeamError').classList.add('hidden');
    }

    function hideJoinTeamModal() {
      document.getElementById('joinTeamModal').classList.add('hidden');
    }

    async function joinTeamByCode() {
      const code = document.getElementById('joinTeamCode').value.trim().toUpperCase();
      const err = document.getElementById('joinTeamError');
      if (!code) return;
      try {
        await API.joinTeamByCode(code);
        hideJoinTeamModal();
        await refreshTeamList();
      } catch (e) {
        err.textContent = e.message;
        err.classList.remove('hidden');
      }
    }

    function showCreateTeamModal() {
      if (currentUser.globalRole !== 'superadmin') {
        alert('Team creation requires superadmin privileges.');
        return;
      }
      document.getElementById('createTeamModal').classList.remove('hidden');
      document.getElementById('createTeamName').value = '';
      document.getElementById('createTeamError').classList.add('hidden');
      document.getElementById('createTeamSuccess').classList.add('hidden');
    }

    function hideCreateTeamModal() {
      document.getElementById('createTeamModal').classList.add('hidden');
    }

    async function createTeam() {
      const name = document.getElementById('createTeamName').value.trim();
      const err = document.getElementById('createTeamError');
      const success = document.getElementById('createTeamSuccess');
      if (!name) return;
      try {
        const result = await API.createTeam(name);
        success.textContent = `Team "${result.name}" created! Code: ${result.code}`;
        success.classList.remove('hidden');
        err.classList.add('hidden');
        await refreshTeamList();
        setTimeout(() => hideCreateTeamModal(), 2000);
      } catch (e) {
        err.textContent = e.message;
        err.classList.remove('hidden');
        success.classList.add('hidden');
      }
    }

    function backToTeamSelector() {
      if (refreshInterval) clearInterval(refreshInterval);
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('teamSelectorScreen').classList.remove('hidden');
      refreshTeamList();
    }

    async function selectTeam(teamId, teamName) {
      const team = userTeams.find(t => t.id === teamId);
      if (!team) return;

      currentTeam = team;
      API.setTeam(teamId);
      document.getElementById('teamSelectorScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      document.getElementById('headerTeamName').textContent = teamName.toUpperCase();
      
      // Set initial filter states
      taskFilter = 'all';
      priorityFilter = null;
      searchQuery = '';
      document.getElementById('taskSearch').value = '';
      setPriorityFilter(null);
      setTaskFilter('all');
      
      loadData();

      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(loadData, 30000);
    }

    function logout() {
      if (confirm('Logout?')) {
        API.clearSession();
        window.location.reload();
      }
    }

    async function loadData() {
      if (!currentTeam) return;

      try {
        const [taskData, members, stats, analytics, activity, kudos] = await Promise.all([
          API.getTasks(currentTeam.id, taskFilter === 'mine' ? 'mine' : null),
          API.getTeamMembers(currentTeam.id),
          API.getTeamStats(currentTeam.id),
          API.getWeeklyAnalytics(currentTeam.id),
          API.getActivityFeed(currentTeam.id, 15),
          API.getKudos(currentTeam.id).catch(() => [])
        ]);

        tasks = taskData;
        teamMembers = members;

        // Sync user XP from team membership
        const myMembership = members.find(m => m.id === currentUser.id);
        if (myMembership) {
          currentUser.xp = myMembership.xp || 0;
          currentUser.streak = myMembership.streak || 0;
          currentUser.tasksCompleted = myMembership.tasksCompleted || 0;
          currentUser.mascotColor = myMembership.mascotColor || 'red';
        }

        renderTasks();
        renderLeaderboard(analytics.members || []);
        renderActivity(activity);
        renderSidebarActivity(activity);
        renderKudos(kudos);
        updateUserDisplay();
        updateStats(stats);
        updateAssignDropdown();
        updateTeamAdminVisibility();
        updateChallenges();
        lucide.createIcons();
      } catch (e) {
        console.error('Refresh error:', e);
      }
    }

    function updateUserDisplay() {
      const xp = currentUser.xp || 0;
      const p = getThemeRankData(xp);
      const sprite = getThemeSprite(p);
      const ranks = activeTheme.ranks;
      const nextP = ranks.find(x => x.xp > xp) || ranks[ranks.length - 1];
      const progress = xp < nextP.xp ? ((xp - p.xp) / (nextP.xp - p.xp)) * 100 : 100;

      document.getElementById('sidebarUserName').textContent = currentUser.displayName;
      document.getElementById('sidebarLevelTag').textContent = `LV. ${p.level}`;
      document.getElementById('sidebarRank').textContent = p.name;
      document.getElementById('sidebarXP').textContent = xp;
      const xpBarWidth = `${Math.min(100, Math.max(5, progress))}%`;
      ChampAnimations.animateXPBar('sidebarXPBar', xpBarWidth);
      document.getElementById('sidebarNextXP').textContent = nextP.xp;

      // Sidebar & companion sprite (image or emoji)
      const sidebarSprite = document.getElementById('sidebarSprite');
      const sidebarEmoji = document.getElementById('sidebarEmoji');
      const companionSprite = document.getElementById('companionSprite');
      const companionEmoji = document.getElementById('companionEmoji');

      if (sprite.isEmoji) {
        sidebarSprite.style.display = 'none';
        sidebarEmoji.textContent = sprite.emoji;
        sidebarEmoji.classList.remove('hidden');
        companionSprite.style.display = 'none';
        companionEmoji.textContent = sprite.emoji;
        companionEmoji.classList.remove('hidden');
      } else {
        sidebarEmoji.classList.add('hidden');
        companionEmoji.classList.add('hidden');
        sidebarSprite.style.display = '';
        sidebarSprite.dataset.fallback = sprite.fallback || '';
        sidebarSprite.src = sprite.url;
        companionSprite.style.display = '';
        companionSprite.dataset.fallback = sprite.fallback || '';
        companionSprite.src = sprite.url;
      }

      document.getElementById('companionName').textContent = p.spriteName;
      document.getElementById('companionEvolution').textContent = `STG ${Math.floor(p.level / 10) + 1} ‚Ä¢ ${p.name}`;
      document.getElementById('evolutionProgressBar').style.width = `${Math.min(100, progress)}%`;
      document.getElementById('evolutionProgressText').textContent = `${Math.round(progress)}%`;
      document.getElementById('companionNote').textContent = getCompanionQuote(p.level);

      if (document.getElementById('themeSelector')) {
        document.getElementById('themeSelector').value = currentUser.themePreference || 'pokemon';
      }
    }

    function updateStats(team) {
      ChampAnimations.animateCounter('statActive', tasks.filter(t => !t.completed).length);
      ChampAnimations.animateCounter('statToday', team.completedTasks || 0);
      ChampAnimations.animateCounter('statStreak', currentUser.streak || 0);
      document.getElementById('statMVP').textContent = team.topTrainer || '-';
    }

    function updateAssignDropdown() {
      const el = document.getElementById('newTaskAssign');
      el.innerHTML = '<option value="">üë§ Unassigned</option>' +
        teamMembers.map(m => `<option value="${m.id}">${m.displayName} ${m.id === currentUser.id ? '(You)' : ''}</option>`).join('');
    }

    function updateTeamAdminVisibility() {
      const member = teamMembers.find(m => m.id === currentUser.id);
      const isAdmin = member && member.role === 'admin';
      document.getElementById('teamAdminBtn').classList.toggle('hidden', !isAdmin);
      document.getElementById('settingsBtn').classList.remove('hidden');
    }

    let priorityFilter = null;
    let searchQuery = '';

    function setPriorityFilter(priority) {
      priorityFilter = priority;
      document.querySelectorAll('[id^="filterPriority"]').forEach(b => {
        b.classList.remove('bg-red-600', 'bg-amber-600', 'bg-blue-600', 'bg-emerald-600');
        b.classList.add('bg-slate-800');
      });
      if (priority) {
        const btn = document.getElementById('filterPriority' + priority);
        if (btn) {
          const colors = { P0: 'bg-red-600', P1: 'bg-amber-600', P2: 'bg-blue-600', P3: 'bg-emerald-600' };
          btn.classList.remove('bg-slate-800');
          btn.classList.add(colors[priority]);
        }
      } else {
        document.getElementById('filterPriorityAll').classList.remove('bg-slate-800');
        document.getElementById('filterPriorityAll').classList.add('bg-red-600');
      }
      renderTasks();
    }

    function filterTasks() {
      searchQuery = document.getElementById('taskSearch').value.toLowerCase();
      renderTasks();
    }

    function renderTasks() {
      const container = document.getElementById('taskList');
      let filtered = tasks;
      
      // Apply search filter
      if (searchQuery) {
        filtered = filtered.filter(t => 
          t.title.toLowerCase().includes(searchQuery) ||
          (t.category && t.category.toLowerCase().includes(searchQuery)) ||
          (t.assignedToName && t.assignedToName.toLowerCase().includes(searchQuery))
        );
      }
      
      // Apply priority filter
      if (priorityFilter) {
        filtered = filtered.filter(t => t.priority === priorityFilter);
      }

      const groups = { P0: [], P1: [], P2: [], P3: [], done: [] };
      filtered.forEach(t => {
        if (t.completed) groups.done.push(t);
        else groups[t.priority].push(t);
      });

      if (filtered.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        container.innerHTML = '';
        return;
      }
      document.getElementById('emptyState').classList.add('hidden');

      let html = '';
      ['P0', 'P1', 'P2', 'P3', 'done'].forEach(g => {
        if (groups[g].length > 0) {
          html += groups[g].map(t => {
            const dueSoon = t.dueDate && !t.completed && new Date(t.dueDate) <= new Date(Date.now() + 2 * 86400000);
            const overdue = t.dueDate && !t.completed && new Date(t.dueDate) < new Date();
            return `
            <div class="task-card priority-${t.priority.toLowerCase()} ${t.completed ? 'completed' : ''} p-4">
              <div class="flex items-start gap-4">
                <button onclick="toggleTask(${t.id}, ${t.completed})" class="mt-1 w-6 h-6 rounded-full border-2 border-slate-700 flex items-center justify-center flex-shrink-0 ${t.completed ? 'bg-emerald-500 border-emerald-500' : 'hover:border-red-500 transition-colors'}">
                  ${t.completed ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                </button>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1 flex-wrap">
                    <span class="pixel-font text-[9px] px-1.5 py-0.5 rounded ${getPriorityStyles(t.priority)}">${t.priority}</span>
                    ${t.category ? `<span class="text-[9px] px-1.5 py-0.5 rounded bg-slate-700 text-slate-300">${t.category}</span>` : ''}
                    <span class="text-[10px] text-slate-500">assigned to <b>${t.assignedToName || 'Anyone'}</b></span>
                  </div>
                  <h4 class="font-medium text-sm ${t.completed ? 'line-through text-slate-600' : 'text-slate-200'}">${t.title}</h4>
                  <div class="flex items-center gap-3 mt-1 flex-wrap">
                    ${t.dueDate ? `<span class="text-[10px] ${overdue ? 'text-red-500 font-bold' : dueSoon ? 'text-amber-500' : 'text-slate-500'}"><i data-lucide="calendar" class="w-3 h-3 inline"></i> ${new Date(t.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>` : ''}
                    ${t.timeEstimate ? `<span class="text-[10px] text-slate-500"><i data-lucide="clock" class="w-3 h-3 inline"></i> ${t.timeEstimate}</span>` : ''}
                    ${t.notes ? `<span class="text-[10px] text-slate-600" title="${t.notes.replace(/"/g, '&quot;')}"><i data-lucide="file-text" class="w-3 h-3 inline"></i> notes</span>` : ''}
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <span class="pixel-font text-xs text-slate-500">${getPriorityXP(t.priority)} XP</span>
                  <button onclick="showEditTaskModal(${t.id})" class="text-slate-600 hover:text-blue-500"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                  <button onclick="deleteTask(${t.id})" class="text-slate-600 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
              </div>
            </div>
          `}).join('');
        }
      });
      container.innerHTML = html;
      lucide.createIcons();
      ChampAnimations.animateTasksIn();
    }

    function getPriorityStyles(p) {
      if (p === 'P0') return 'bg-red-500/20 text-red-500';
      if (p === 'P1') return 'bg-amber-500/20 text-amber-500';
      if (p === 'P2') return 'bg-blue-500/20 text-blue-500';
      return 'bg-emerald-500/20 text-emerald-500';
    }
    function getPriorityXP(p) { return { P0: 50, P1: 30, P2: 20, P3: 10 }[p] || 20; }

    async function toggleTask(id, current) {
      if (!currentTeam) return;
      if (current) {
        await API.uncompleteTask(currentTeam.id, id);
      } else {
        const result = await API.completeTask(currentTeam.id, id);
        if (result.leveledUp) {
          ChampAnimations.levelUpCelebration();
        }
      }
      loadData();
    }

    async function deleteTask(id) {
      if (!currentTeam) return;
      if (confirm('Delete this mission?')) {
        await API.deleteTask(currentTeam.id, id);
        loadData();
      }
    }

    function renderLeaderboard(members) {
      const container = document.getElementById('leaderboard');
      const term = activeTheme.terminology;
      container.innerHTML = members.slice(0, 5).map((u, i) => {
        const p = getThemeRankData(u.xp || 0);
        const sprite = getThemeSprite(p);
        const spriteHtml = sprite.isEmoji
          ? `<span class="text-xl">${sprite.emoji}</span>`
          : `<img src="${sprite.url}" class="w-8 h-8 relative z-10 pokemon-sprite">`;
        return `
          <div class="flex items-center gap-3 group">
            <div class="w-8 h-8 rounded-lg bg-slate-900 border border-slate-800 flex items-center justify-center relative overflow-hidden">
               ${spriteHtml}
            </div>
            <div class="flex-1 min-w-0">
               <div class="text-xs font-medium text-slate-300 truncate">${u.displayName || u.name}</div>
               <div class="text-[9px] text-slate-600 pixel-font">Lv. ${p.level} ‚Ä¢ ${u.xp || 0} ${term.xp}</div>
            </div>
            <div class="pixel-font text-xs ${i === 0 ? 'text-amber-500' : 'text-slate-700'}">#${i + 1}</div>
          </div>
        `;
      }).join('');
    }

    function renderActivity(list) {
      const container = document.getElementById('activityFeed');
      if (!container) return;
      container.innerHTML = list.map(a => `
        <div class="flex gap-3 text-xs">
          <div class="w-1 h-8 rounded bg-slate-800 flex-shrink-0"></div>
          <div>
            <span class="text-slate-300 font-bold">${a.userName || 'Unknown'}</span>
            <span class="text-slate-500"> ${getActivityText(a)}</span>
            <div class="text-[9px] text-slate-600 mt-0.5">${new Date(a.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
          </div>
        </div>
      `).join('');
    }

    function renderSidebarActivity(list) {
      const container = document.getElementById('sidebarActivity');
      if (!container) return;
      container.innerHTML = list.slice(0, 5).map(a => {
        const verb = a.action === 'task_completed' ? 'completed a task' :
                     a.action === 'task_created' ? 'added a task' :
                     a.action === 'level_up' ? 'leveled up!' :
                     a.action === 'team_joined' ? 'joined' :
                     a.action === 'kudos_given' ? 'sent kudos' :
                     a.action.replace('_', ' ');
        return `<div class="text-[10px] text-slate-500 truncate"><span class="text-slate-400 font-medium">${a.userName || 'Someone'}</span> ${verb}</div>`;
      }).join('');
    }

    function getActivityText(a) {
      if (a.action === 'task_completed') return `completed "${a.taskTitle}" (+${a.xpEarned} XP)`;
      if (a.action === 'task_created') return `added a new task: "${a.taskTitle}"`;
      if (a.action === 'task_deleted') return `deleted task: "${a.taskTitle}"`;
      if (a.action === 'task_assigned') return `assigned task: "${a.taskTitle}"`;
      if (a.action === 'task_edited') return `edited task: "${a.taskTitle}"`;
      if (a.action === 'level_up') return `leveled up!`;
      if (a.action === 'team_joined') return `joined the team`;
      if (a.action === 'role_changed') return `changed a member's role`;
      return a.action;
    }

    function updateChallenges() {
      const container = document.getElementById('dailyChallenges');
      const myUserId = currentUser.id;
      const todayDone = tasks.filter(t => t.completed && t.completedByUserId === myUserId).length;
      const streak = currentUser.streak || 0;

      // Rotating social challenges (one per day)
      const socialChallenges = [
        "Give a genuine compliment to a teammate",
        "Ask someone about their weekend plans",
        "Share a helpful resource with the team",
        "Send kudos to someone who helped you",
        "Offer to help a teammate with their task",
        "Share something you learned today",
        "Celebrate a teammate's achievement"
      ];
      const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
      const todaySocial = socialChallenges[dayOfYear % socialChallenges.length];

      const challenges = [
        { label: 'Complete 3 Tasks Today', value: todayDone, max: 3, xp: 50, type: 'task' },
        { label: 'Finish a P0 Quest', value: tasks.filter(t => t.completed && t.priority === 'P0' && t.completedByUserId === myUserId).length, max: 1, xp: 30, type: 'task' },
        { label: todaySocial, value: 0, max: 1, xp: 10, type: 'social' }
      ];
      container.innerHTML = challenges.map(c => `
        <div class="space-y-2">
          <div class="flex justify-between text-[10px]">
            <span class="text-slate-300 font-medium">${c.type === 'social' ? '\u{1F91D} ' : ''}${c.label}</span>
            <span class="text-amber-500 font-bold">+${c.xp} XP</span>
          </div>
          ${c.type === 'task' ? `
          <div class="xp-bar-bg h-1.5">
            <div class="xp-bar-fill" style="width: ${Math.min(100, (c.value / c.max) * 100)}%;"></div>
          </div>
          <div class="text-[9px] text-slate-600 text-right">${c.value}/${c.max} Done</div>
          ` : `<div class="text-[9px] text-slate-500 italic">Honor system - be a Champion!</div>`}
        </div>
      `).join('');
    }

    // ============ KUDOS ============
    let selectedKudosEmoji = '\u{1F389}';

    function toggleKudosForm() {
      const form = document.getElementById('kudosForm');
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        const el = document.getElementById('kudosRecipient');
        el.innerHTML = '<option value="">Select teammate...</option>' +
          teamMembers.filter(m => m.id !== currentUser.id).map(m => `<option value="${m.id}">${m.displayName}</option>`).join('');
      }
    }

    function selectKudosEmoji(btn, emoji) {
      selectedKudosEmoji = emoji;
      document.querySelectorAll('.kudos-emoji-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    async function sendKudos() {
      const toUserId = document.getElementById('kudosRecipient').value;
      const message = document.getElementById('kudosMessage').value.trim();
      const errEl = document.getElementById('kudosError');
      errEl.classList.add('hidden');

      if (!toUserId || !message) {
        errEl.textContent = 'Select a teammate and write a message';
        errEl.classList.remove('hidden');
        return;
      }

      try {
        await API.sendKudos(currentTeam.id, parseInt(toUserId), message, selectedKudosEmoji);
        document.getElementById('kudosMessage').value = '';
        document.getElementById('kudosForm').classList.add('hidden');
        loadData();
      } catch (e) {
        errEl.textContent = e.message;
        errEl.classList.remove('hidden');
      }
    }

    function renderKudos(kudosList) {
      const feed = document.getElementById('kudosFeed');
      if (!feed) return;
      if (!kudosList || kudosList.length === 0) {
        feed.innerHTML = '<div class="text-center text-slate-600 text-xs py-4">No kudos yet. Be the first!</div>';
        return;
      }
      feed.innerHTML = kudosList.map(k => `
        <div class="bg-slate-900/50 rounded-lg p-2.5">
          <div class="text-xs">
            <span class="text-lg mr-1">${k.emoji}</span>
            <span class="text-pink-400 font-bold">${k.fromUserName}</span>
            <span class="text-slate-500"> \u2192 </span>
            <span class="text-slate-300 font-bold">${k.toUserName}</span>
          </div>
          <div class="text-[11px] text-slate-400 mt-1 ml-7">${k.message}</div>
          <div class="text-[9px] text-slate-600 mt-1 ml-7">${new Date(k.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      `).join('');
    }

    // ============ SETTINGS ============
    async function showSettingsModal() {
      document.getElementById('settingsModal').classList.remove('hidden');
      document.getElementById('settingsDisplayName').textContent = currentUser.displayName;
      document.getElementById('settingsThemeSelect').value = currentUser.themePreference || 'pokemon';

      // Show webhook section for team admins
      const member = teamMembers.find(m => m.id === currentUser.id);
      const webhookSection = document.getElementById('settingsWebhookSection');
      if (member && member.role === 'admin' && currentTeam) {
        webhookSection.classList.remove('hidden');
        try {
          const settings = await API.getTeamSettings(currentTeam.id);
          const wh = settings.webhooks || {};
          document.getElementById('settingsWebhookUrl').value = wh.url || '';
          document.getElementById('settingsWebhookEnabled').checked = !!wh.enabled;
          document.querySelectorAll('.webhook-event').forEach(cb => {
            cb.checked = wh.events ? wh.events.includes(cb.value) : (cb.value === 'task_completed' || cb.value === 'level_up');
          });
        } catch (e) {
          console.log('Settings load note:', e.message);
        }
      } else {
        webhookSection.classList.add('hidden');
      }
    }

    function hideSettingsModal() {
      document.getElementById('settingsModal').classList.add('hidden');
    }

    async function saveWebhookSettings() {
      if (!currentTeam) return;
      const statusEl = document.getElementById('settingsWebhookStatus');
      const events = [];
      document.querySelectorAll('.webhook-event:checked').forEach(cb => events.push(cb.value));

      try {
        await API.updateTeamSettings(currentTeam.id, {
          webhooks: {
            url: document.getElementById('settingsWebhookUrl').value.trim(),
            enabled: document.getElementById('settingsWebhookEnabled').checked,
            events
          }
        });
        statusEl.textContent = 'Webhook settings saved!';
        statusEl.className = 'text-[10px] text-emerald-500';
        statusEl.classList.remove('hidden');
        setTimeout(() => statusEl.classList.add('hidden'), 3000);
      } catch (e) {
        statusEl.textContent = e.message;
        statusEl.className = 'text-[10px] text-red-500';
        statusEl.classList.remove('hidden');
      }
    }

    async function testWebhook() {
      if (!currentTeam) return;
      const statusEl = document.getElementById('settingsWebhookStatus');
      try {
        await API.testWebhook(currentTeam.id);
        statusEl.textContent = 'Test webhook sent successfully!';
        statusEl.className = 'text-[10px] text-emerald-500';
        statusEl.classList.remove('hidden');
        setTimeout(() => statusEl.classList.add('hidden'), 3000);
      } catch (e) {
        statusEl.textContent = e.message;
        statusEl.className = 'text-[10px] text-red-500';
        statusEl.classList.remove('hidden');
      }
    }

    function parseNotes() {
      const input = document.getElementById('quickCaptureInput').value.trim();
      if (!input) return;

      parsedTasks = [];
      const sentences = input.split(/[.!?\n]|(?:also|plus|and also)/gi).map(s => s.trim()).filter(s => s.length > 5);

      sentences.forEach(s => {
        const task = parseSentence(s);
        if (task.title) parsedTasks.push(task);
      });

      renderParsedPreview();
    }

    function parseSentence(text) {
      const task = { title: text, priority: 'P2', assignedTo: null };
      if (/\b(urgent|asap|p0|critical)\b/i.test(text)) task.priority = 'P0';
      else if (/\b(high|important|p1|soon)\b/i.test(text)) task.priority = 'P1';
      else if (/\b(low|whenever|p3)\b/i.test(text)) task.priority = 'P3';

      const assignedMatch = text.match(/(?:assign(?:ed)? to|for|@)\s*([A-Za-z]+)/);
      if (assignedMatch) {
        const name = assignedMatch[1].toLowerCase();
        const found = teamMembers.find(m => m.displayName.toLowerCase().includes(name));
        if (found) task.assignedTo = found.id;
      }

      task.title = text.replace(/(?:urgent|asap|p0|critical|high|important|p1|soon|low|whenever|p3|assign(?:ed)? to\s*[A-Za-z]+|for\s*[A-Za-z]+|@\s*[A-Za-z]+)/gi, '').replace(/\s+/g, ' ').trim();
      if (task.title) task.title = task.title.charAt(0).toUpperCase() + task.title.slice(1);
      return task;
    }

    function renderParsedPreview() {
      const preview = document.getElementById('parsedTasksPreview');
      const list = document.getElementById('parsedTasksList');
      preview.classList.remove('hidden');
      list.innerHTML = parsedTasks.map((t, i) => `
        <div class="bg-slate-900 border border-slate-800 p-2 rounded flex justify-between items-center">
          <div class="text-xs">
            <span class="pixel-font text-[9px] mr-2 ${getPriorityStyles(t.priority)}">${t.priority}</span>
            <span class="text-slate-300">${t.title}</span>
            ${t.assignedTo ? `<span class="text-[10px] text-slate-500 ml-2">üë§ ${teamMembers.find(m => m.id === t.assignedTo)?.displayName}</span>` : ''}
          </div>
          <button onclick="parsedTasks.splice(${i}, 1); renderParsedPreview()" class="text-slate-600 hover:text-red-500">‚úï</button>
        </div>
      `).join('');
    }

    async function confirmParsedTasks() {
      if (!currentTeam) return;
      for (const t of parsedTasks) { await API.createTask(currentTeam.id, t); }
      parsedTasks = [];
      document.getElementById('quickCaptureInput').value = '';
      document.getElementById('parsedTasksPreview').classList.add('hidden');
      loadData();
    }

    function cancelParsedTasks() {
      parsedTasks = [];
      document.getElementById('quickCaptureInput').value = '';
      document.getElementById('parsedTasksPreview').classList.add('hidden');
    }

    function clearCapture() {
      document.getElementById('quickCaptureInput').value = '';
      cancelParsedTasks();
    }

    function setTaskFilter(filter) {
      taskFilter = filter;

      // Update active visual state
      document.querySelectorAll('#filterAll, #filterMine').forEach(b => {
        b.classList.remove('text-white', 'bg-slate-800');
        b.classList.add('text-slate-400');
      });
      const activeBtn = document.getElementById(filter === 'mine' ? 'filterMine' : 'filterAll');
      if (activeBtn) {
        activeBtn.classList.add('text-white', 'bg-slate-800');
        activeBtn.classList.remove('text-slate-400');
      }

      loadData();
    }

    async function changeUserTheme(val) {
      ChampAnimations.animateThemeTransition(() => {
        applyTheme(val);
        currentUser.themePreference = val;
        updateUserDisplay();
        ChampAnimations.animateCompanionEntrance();
      });
      await API.setTheme(val);
      if (currentTeam) loadData();
    }

    function showTaskForm() { document.getElementById('taskModal').classList.remove('hidden'); }
    function hideTaskForm() { document.getElementById('taskModal').classList.add('hidden'); }

    async function addTask() {
      if (!currentTeam) return;
      const title = document.getElementById('newTaskInput').value.trim();
      const priority = document.getElementById('newTaskPriority').value;
      const assignedTo = document.getElementById('newTaskAssign').value;
      const category = document.getElementById('newTaskCategory').value.trim();
      const dueDate = document.getElementById('newTaskDueDate').value;
      const timeEstimate = document.getElementById('newTaskTimeEstimate').value.trim();
      const notes = document.getElementById('newTaskNotes').value.trim();
      if (!title) return;
      await API.createTask(currentTeam.id, {
        title, priority,
        assignedTo: assignedTo || null,
        category: category || null,
        dueDate: dueDate || null,
        timeEstimate: timeEstimate || null,
        notes: notes || null
      });
      hideTaskForm();
      document.getElementById('newTaskInput').value = '';
      document.getElementById('newTaskCategory').value = '';
      document.getElementById('newTaskDueDate').value = '';
      document.getElementById('newTaskTimeEstimate').value = '';
      document.getElementById('newTaskNotes').value = '';
      loadData();
    }

    function showEditTaskModal(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      document.getElementById('editTaskId').value = taskId;
      document.getElementById('editTaskTitle').value = task.title;
      document.getElementById('editTaskPriority').value = task.priority;
      document.getElementById('editTaskCategory').value = task.category || '';
      document.getElementById('editTaskDueDate').value = task.dueDate ? task.dueDate.split('T')[0] : '';
      document.getElementById('editTaskTimeEstimate').value = task.timeEstimate || '';
      document.getElementById('editTaskNotes').value = task.notes || '';

      const assignEl = document.getElementById('editTaskAssign');
      assignEl.innerHTML = '<option value="">Unassigned</option>' +
        teamMembers.map(m => `<option value="${m.id}" ${m.id === task.assignedTo ? 'selected' : ''}>${m.displayName}${m.id === currentUser.id ? ' (You)' : ''}</option>`).join('');

      document.getElementById('editTaskModal').classList.remove('hidden');
    }

    function hideEditTaskModal() {
      document.getElementById('editTaskModal').classList.add('hidden');
    }

    async function saveEditTask() {
      if (!currentTeam) return;
      const taskId = document.getElementById('editTaskId').value;
      const updates = {
        title: document.getElementById('editTaskTitle').value.trim(),
        priority: document.getElementById('editTaskPriority').value,
        assignedTo: document.getElementById('editTaskAssign').value || null,
        category: document.getElementById('editTaskCategory').value.trim() || null,
        dueDate: document.getElementById('editTaskDueDate').value || null,
        timeEstimate: document.getElementById('editTaskTimeEstimate').value.trim() || null,
        notes: document.getElementById('editTaskNotes').value.trim() || null
      };
      if (!updates.title) return;
      try {
        await API.updateTask(currentTeam.id, taskId, updates);
        hideEditTaskModal();
        loadData();
      } catch (e) {
        alert(e.message);
      }
    }

    async function showTeamAdminModal() {
      if (!currentTeam) return;
      document.getElementById('teamAdminModal').classList.remove('hidden');
      const members = teamMembers;
      document.getElementById('teamMemberList').innerHTML = members.map(m => `
        <div class="bg-slate-900 p-4 rounded-lg flex items-center justify-between">
          <div>
            <div class="font-bold text-white">${m.displayName} <span class="text-[10px] pixel-font text-slate-500 ml-2">${m.role}</span></div>
            <div class="text-xs text-slate-500">XP: ${m.xp || 0} ‚Ä¢ Tasks: ${m.tasksCompleted || 0}</div>
          </div>
          <div class="flex gap-2">
            ${m.id !== currentUser.id ? `
              <button onclick="toggleMemberRole(${m.id}, '${m.role}')" class="text-xs text-blue-500 bg-blue-500/10 px-3 py-1 rounded">${m.role === 'admin' ? 'Demote' : 'Promote'}</button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    function hideTeamAdminModal() { document.getElementById('teamAdminModal').classList.add('hidden'); }

    async function toggleMemberRole(userId, currentRole) {
      if (!currentTeam) return;
      const newRole = currentRole === 'admin' ? 'member' : 'admin';
      await API.updateMemberRole(currentTeam.id, userId, newRole);
      await loadData();
      showTeamAdminModal();
    }

    async function showSuperadminPanel() {
      document.getElementById('teamSelectorScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('superadminPanel').classList.remove('hidden');
      lucide.createIcons();
      await loadAdminData();
    }

    function closeSuperadminPanel() {
      document.getElementById('superadminPanel').classList.add('hidden');
      showTeamSelector();
    }

    function showAdminTab(tab) {
      document.getElementById('adminTeamsContent').classList.toggle('hidden', tab !== 'teams');
      document.getElementById('adminUsersContent').classList.toggle('hidden', tab !== 'users');
      document.getElementById('adminTabTeams').className = `pixel-font text-xs px-4 py-2 rounded ${tab === 'teams' ? 'bg-amber-600 text-white' : 'bg-slate-800 text-slate-400'}`;
      document.getElementById('adminTabUsers').className = `pixel-font text-xs px-4 py-2 rounded ${tab === 'users' ? 'bg-amber-600 text-white' : 'bg-slate-800 text-slate-400'}`;
    }

    async function loadAdminData() {
      try {
        const [analytics, teams, users] = await Promise.all([
          API.getAdminAnalytics(),
          API.getAdminTeams(),
          API.getAdminUsers()
        ]);

        document.getElementById('adminStatTeams').textContent = analytics.totalTeams;
        document.getElementById('adminStatUsers').textContent = analytics.totalUsers;
        document.getElementById('adminStatTasks').textContent = analytics.totalTasks;
        document.getElementById('adminStatCompleted').textContent = analytics.completedTasks;

        renderAdminTeams(teams);
        renderAdminUsers(users);
        lucide.createIcons();
      } catch (e) {
        console.error('Admin load error:', e);
      }
    }

    function renderAdminTeams(teams) {
      document.getElementById('adminTeamsList').innerHTML = teams.map(t => `
        <div class="glass-card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-white">${t.name}</div>
              <div class="text-xs text-slate-500">Code: <span class="text-amber-500 font-mono">${t.code}</span> | Created by: ${t.createdBy || 'System'}</div>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-right">
                <div class="text-xs text-slate-400"><span class="text-white font-bold">${t.memberCount}</span> members</div>
                <div class="text-xs text-slate-400"><span class="text-white font-bold">${t.taskCount}</span> tasks (${t.completedTaskCount} done)</div>
              </div>
              <button onclick="adminDeleteTeam(${t.id}, '${t.name.replace(/'/g, "\\'")}')" class="text-slate-600 hover:text-red-500 p-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderAdminUsers(users) {
      document.getElementById('adminUsersList').innerHTML = users.map(u => `
        <div class="glass-card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-white">${u.displayName} ${u.globalRole === 'superadmin' ? '<span class="text-[10px] pixel-font text-amber-500 ml-2">SUPERADMIN</span>' : ''}</div>
              <div class="text-xs text-slate-500">${u.email} | ${u.teamCount} team(s)</div>
            </div>
            <div class="flex items-center gap-2">
              ${u.id !== currentUser.id ? `
                <button onclick="adminToggleRole(${u.id}, '${u.globalRole}')" class="text-xs px-3 py-1 rounded ${u.globalRole === 'superadmin' ? 'bg-red-500/10 text-red-500' : 'bg-amber-500/10 text-amber-500'}">
                  ${u.globalRole === 'superadmin' ? 'Demote' : 'Promote'}
                </button>
              ` : '<span class="text-[10px] text-slate-600">(you)</span>'}
            </div>
          </div>
        </div>
      `).join('');
    }

    async function adminCreateTeam() {
      const name = prompt('Enter new team name:');
      if (!name) return;
      try {
        await API.createTeam(name);
        await loadAdminData();
      } catch (e) {
        alert(e.message);
      }
    }

    async function adminDeleteTeam(teamId, teamName) {
      if (!confirm(`Delete team "${teamName}"? This will remove all members and tasks.`)) return;
      try {
        await API.deleteTeam(teamId);
        await loadAdminData();
      } catch (e) {
        alert(e.message);
      }
    }

    async function adminToggleRole(userId, currentRole) {
      const newRole = currentRole === 'superadmin' ? 'user' : 'superadmin';
      if (newRole === 'superadmin' && !confirm('Promote this user to superadmin?')) return;
      try {
        await API.updateUserGlobalRole(userId, newRole);
        await loadAdminData();
      } catch (e) {
        alert(e.message);
      }
    }

    init();
  </script>
</body>

</html>